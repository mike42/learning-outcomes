/*
 * Learning outcome analysis code.
 * 
 * (C) Monash University 2014
 */
function outcomes_read_passages(a){var b,c,d="",e,g=[];for(c=0;c<a.length;c++)b=a.substring(c,c+1),d+=b,b=-1!="\n\r".indexOf(b)||c==a.length-1,!0==b&&0<d.trim().length&&(b=outcomes_read_passage(d),e=outcomes_outcome_feedback(b),0<e.stats.word_c&&g.push({outcome_original:d,outcome:b,feedback:e}),d="");return{outcomes:g,feedback:outcomes_overall_feedback(g)}}
function outcomes_word_filter(a){3<a.length&&"ize"==a.substr(a.length-3,3)?a=a.substr(0,a.length-3)+"ise":3<a.length&&"yze"==a.substr(a.length-3,3)?a=a.substr(0,a.length-3)+"yse":4<a.length&&"ized"==a.substr(a.length-4,4)&&(a=a.substr(0,a.length-3)+"ised");return a}
function outcomes_read_passage(a){var b,c,d,e=0,g="";for(b=0;b<a.length;b++){c=a.substring(b,b+1).toLowerCase();if("."==c&&0==e){if(d=a.substring(b+1,b+2).toLowerCase(),""==d||-1=="abcdefghijklmnopqrstuvwxyz-'1234567890.".indexOf(d))c="\n"}else"("==c?e++:")"==c&&(e--,0>e&&(e=0));g+=c}a=!1;var f="",h=[],k=[];for(b=0;b<g.length;b++)c=g.substring(b,b+1).toLowerCase(),d=-1!="abcdefghijklmnopqrstuvwxyz-'1234567890.".indexOf(c),e=-1!="\n\r?!".indexOf(c),!1==d&&!0==a?(h.push([outcomes_word_filter(f),outcomes_word_syllable(f)]),
f=""):!0==d&&(f+=c),0<h.length&&e&&(k.push(h),h=[]),a=d;0<f.length&&h.push([outcomes_word_filter(f),outcomes_word_syllable(f)]);0<h.length&&k.push(h);return k}function outcomes_passage_readability(a,b,c){return 0==b||0==a?NaN:206.835-1.015*(a/b)-84.6*(c/a)}function outcomes_word_syllable(a){if(3>=a.length)return 1;a=a.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/,"");a=a.replace(/^y/,"");a=a.match(/[aeiouy]{1,2}/g);return null==a?1:a.length}
function outcomes_passage_wordcount(a){var b=0,c=0,d=0,e,g,c=a.length;for(e=0;e<a.length;e++){b+=a[e].length;for(g=0;g<a[e].length;g++)d+=a[e][g][1]}return{totalWords:b,totalSentences:c,totalSyllables:d}}function outcomes_repetition(a){var b={};for(i=0;i<a.length;i++)for(j=0;j<a[i].length;j++)1>=a[i][j][1]||(w=a[i][j][0],void 0==b[w]&&(b[w]=0),b[w]++);a=outcomes_objSortRev(b);var c=0,d=[];for(i=0;i<a.length&&3>c;i++)3<b[a[i]]&&(d.push(a[i]),c++);return d}
function outcomes_keyword_match(a,b){var c,d,e,g,f,h,k={},l=[];for(c=0;c<a.length;c++){g=a[c].split(" ");for(d=0;d<b.length;d++)for(e=0;e<b[d].length;e++)if(b[d][e][0]==g[0]){f=1;for(h=!0;f<g.length&&e+f<b[d].length&&h;)h=b[d][e+f][0]==g[f],f++;h&&(h=e+f-1<b[d].length);h&&(f=a[c],void 0==k[f]?(k[f]=1,l.push(f)):k[f]++)}}return l}function outcomes_employability_keywords(a,b){var c,d,e=[];for(c=0;c<a.length;c++)d=outcomes_keyword_match(a[c].list,b),0<d.length&&e.push(a[c].name);return e}
function outcomes_solo_keywords(a,b){var c,d;for(c=a.length-1;0<=c;c--)if(d=outcomes_keyword_match(a[c].list,b),0<d.length)return a[c].name;return""}
function outcomes_outcome_feedback(a){var b=outcomes_passage_wordcount(a);a={word_c:b.totalWords,syllable_c:b.totalSyllables,sentence_c:b.totalSentences,readability:outcomes_passage_readability(b.totalWords,b.totalSentences,b.totalSyllables),repetition:outcomes_repetition(a),flagged:outcomes_keyword_match(outcome_parameters.word_flagged,a),employability:outcomes_employability_keywords(outcome_parameters.skill,a),solo:outcomes_solo_keywords(outcome_parameters.solo,a)};a.repetition_c=a.repetition.length;
a.flagged_c=a.flagged.length;a.employability_c=a.employability.length;a.solonum=""==a.solo?0:1;b=outcomes_compile_messages(a,outcome_parameters.feedback);return{stats:a,messages:b}}
function outcomes_overall_feedback(a){var b,c={min_words:-1};for(b=0;b<a.length;b++)if(-1==c.min_words||a[b].feedback.stats.word_c<c.min_words)c.min_words=a[b].feedback.stats.word_c;-1==c.min_words&&(c.min_words=0);c.outcome_c=a.length;a=outcomes_compile_messages(c,outcome_parameters.overall_feedback);1<a.length&&""==a[a.length-1]&&(a.pop(),c.cancel="yes");return{stats:c,messages:a}}function outcomes_joinWords(a,b){var c="";1<a.length&&(c=" "+b+" "+a.pop());return a.join(", ")+c}
function outcomes_boldList(a){var b=[],c;for(c=0;c<a.length;c++)b.push("<b>"+a[c]+"</b>");return b}function outcomes_objSortRev(a){var b=[],c;for(c in a)b.push(c);return b.sort(function(b,c){return a[b]-a[c]}).reverse()}function outcomes_rand(a,b){return Math.floor(Math.random()*b+a)}function outcomes_random_word(a){return a[outcomes_rand(0,a.length-1)]}
function outcomes_example_words(){var a,b,c={},d=[];for(b=0;b<outcome_parameters.solo.length;b++){do a=outcomes_random_word(outcome_parameters.solo[b].list);while(void 0!==c[a]);c[a]=1;d.push(a)}return d}
function outcomes_compile_messages(a,b){var c=[];for(i=0;i<b.length;i++)if(outcomes_match_message(a,b[i].rule)&&(a.words=outcomes_example_words(),c.push(outcomes_subst_message(b[i].message,a)),void 0!==b[i].cancel))return c.push(""),c;if(void 0!==a.flagged&&0<a.flagged.length){var d="";for(i=0;i<a.flagged.length;i++)if(d=outcomes_find_flagged_message(a.flagged[i],outcome_parameters.flagged_feedback),void 0!=d){a.words=outcomes_example_words();c.push(outcomes_subst_message(d,a));break}}return c}
function outcomes_find_flagged_message(a,b){var c,d;for(c=0;c<b.length;c++)for(d=0;d<b[c].words.length;d++)if(b[c].words[d]==a)return b[c].message}
function outcomes_match_message(a,b){if(0==b.length)return!1;var c,d=!0;for(c=0;c<b.length;c++){d=a[b[c].check];if(void 0===d){d=!1;console.log("A rule tried to use undefined metric: "+b[c].check);break}switch(b[c].is){case "above":d=d>b[c].val;break;case "below":d=d<b[c].val;break;case "equal":d=d==b[c].val;break;case "range":d=d>=b[c].val[0]&&d<=b[c].val[1];break;default:d=!1,console.log("Invalid operator in rule list: "+b[c].is)}if(!d)break}return d}
function outcomes_subst_message(a,b){for(var c in b)b[c]instanceof Array?(a=a.replace("__"+c.toUpperCase()+",OR__",outcomes_joinWords(outcomes_boldList(b[c]),"or")),a=a.replace("__"+c.toUpperCase()+",AND__",outcomes_joinWords(outcomes_boldList(b[c]),"and"))):a=a.replace("__"+c.toUpperCase()+"__",b[c]);return a};
